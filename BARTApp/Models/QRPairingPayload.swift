import Foundation

/// Payload encoded in QR codes generated by `openclaw devices pair --qr`
struct QRPairingPayload: Codable {
    let gatewayUrl: String
    let token: String?             // Gateway token for authentication
    let role: String
    let verificationCode: String?  // Optional one-time verification code
    let expiresAt: Int             // Unix timestamp in milliseconds

    var isExpired: Bool {
        let expirationDate = Date(timeIntervalSince1970: Double(expiresAt) / 1000)
        return Date() > expirationDate
    }

    var hostAndPort: (host: String, port: Int, useSSL: Bool)? {
        // Parse ws://100.71.145.100:18789 or wss://...
        guard let url = URL(string: gatewayUrl) else { return nil }
        let useSSL = url.scheme == "wss"
        let host = url.host ?? ""
        let port = url.port ?? (useSSL ? 443 : 80)
        return (host, port, useSSL)
    }

    /// Decode from base64-encoded JSON string (QR code content)
    static func decode(from qrContent: String) throws -> QRPairingPayload {
        print("ğŸ”“ QRPairingPayload.decode() called")

        // First try: content might be raw JSON
        if qrContent.hasPrefix("{") {
            print("ğŸ”“ Detected raw JSON format")
            guard let data = qrContent.data(using: .utf8) else {
                print("ğŸ”“ âŒ Failed to convert raw JSON to UTF8 data")
                throw QRPairingError.invalidBase64
            }
            print("ğŸ”“ Attempting to decode raw JSON...")
            let payload = try JSONDecoder().decode(QRPairingPayload.self, from: data)
            print("ğŸ”“ âœ… Successfully decoded raw JSON")
            return payload
        }

        print("ğŸ”“ Attempting standard base64 decode...")
        // Second try: base64 encoded JSON
        guard let data = Data(base64Encoded: qrContent) else {
            print("ğŸ”“ Standard base64 failed, trying URL-safe base64...")
            // Try URL-safe base64
            let urlSafe = qrContent
                .replacingOccurrences(of: "-", with: "+")
                .replacingOccurrences(of: "_", with: "/")

            print("ğŸ”“ URL-safe conversion done, adding padding if needed...")
            // Add padding if needed
            let padded = urlSafe.padding(toLength: ((urlSafe.count + 3) / 4) * 4,
                                          withPad: "=",
                                          startingAt: 0)

            guard let paddedData = Data(base64Encoded: padded) else {
                print("ğŸ”“ âŒ URL-safe base64 decode failed")
                throw QRPairingError.invalidBase64
            }
            print("ğŸ”“ âœ… URL-safe base64 decoded, attempting JSON decode...")
            let payload = try JSONDecoder().decode(QRPairingPayload.self, from: paddedData)
            print("ğŸ”“ âœ… Successfully decoded URL-safe base64 JSON")
            return payload
        }

        print("ğŸ”“ âœ… Standard base64 decoded, attempting JSON decode...")
        let payload = try JSONDecoder().decode(QRPairingPayload.self, from: data)
        print("ğŸ”“ âœ… Successfully decoded standard base64 JSON")
        return payload
    }
}

enum QRPairingError: LocalizedError {
    case invalidBase64
    case invalidJSON
    case expired
    case cameraNotAvailable
    case permissionDenied

    var errorDescription: String? {
        switch self {
        case .invalidBase64:
            return "Invalid QR code format"
        case .invalidJSON:
            return "QR code doesn't contain valid pairing data"
        case .expired:
            return "This pairing code has expired. Generate a new one."
        case .cameraNotAvailable:
            return "Camera is not available on this device"
        case .permissionDenied:
            return "Camera permission is required to scan QR codes"
        }
    }
}
